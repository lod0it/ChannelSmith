name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.2.0, v1.0.0

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        run: |
          pyinstaller channelsmith.spec --clean

      - name: Create release archive
        shell: powershell
        run: |
          mkdir ChannelSmith-Windows
          copy dist\ChannelSmith.exe ChannelSmith-Windows\
          copy CHANGELOG.md ChannelSmith-Windows\
          copy README.md ChannelSmith-Windows\
          copy INSTALL.md ChannelSmith-Windows\
          7z a ChannelSmith-Windows.zip ChannelSmith-Windows

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: ChannelSmith-Windows.zip

  build-macos:
    name: Build macOS Executable
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        run: |
          pyinstaller channelsmith.spec --clean

      - name: Create release archive
        run: |
          mkdir -p ChannelSmith-macOS
          cp dist/ChannelSmith ChannelSmith-macOS/
          cp CHANGELOG.md ChannelSmith-macOS/
          cp README.md ChannelSmith-macOS/
          cp INSTALL.md ChannelSmith-macOS/
          tar czf ChannelSmith-macOS.tar.gz ChannelSmith-macOS/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: ChannelSmith-macOS.tar.gz

  build-linux:
    name: Build Linux Executable
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build executable
        run: |
          pyinstaller channelsmith.spec --clean

      - name: Create release archive
        run: |
          mkdir -p ChannelSmith-Linux
          cp dist/ChannelSmith ChannelSmith-Linux/
          cp CHANGELOG.md ChannelSmith-Linux/
          cp README.md ChannelSmith-Linux/
          cp INSTALL.md ChannelSmith-Linux/
          tar czf ChannelSmith-Linux.tar.gz ChannelSmith-Linux/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: ChannelSmith-Linux.tar.gz

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          # Extract the version from the tag
          VERSION=${GITHUB_REF#refs/tags/}

          # Extract release notes for this version
          python3 << 'EOF'
          import re
          version = "${GITHUB_REF#refs/tags/}"

          with open('CHANGELOG.md', 'r') as f:
              content = f.read()

          # Find the section for this version
          pattern = rf'## \[{re.escape(version)}\](.*?)(?=## \[|$)'
          match = re.search(pattern, content, re.DOTALL)

          if match:
              notes = match.group(1).strip()
              print(notes)
          else:
              print(f"Release notes for {version} not found in CHANGELOG.md")
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows-build/ChannelSmith-Windows.zip
            macos-build/ChannelSmith-macOS.tar.gz
            linux-build/ChannelSmith-Linux.tar.gz
          body: |
            # ChannelSmith Release ${{ github.ref }}

            ## Downloads
            - **Windows**: ChannelSmith-Windows.zip
            - **macOS**: ChannelSmith-macOS.tar.gz
            - **Linux**: ChannelSmith-Linux.tar.gz

            ## Installation
            1. Download the appropriate archive for your platform
            2. Extract the archive
            3. Run the executable (no Python required!)

            For detailed installation instructions, see [INSTALL.md](INSTALL.md)

            ## Changes
            See [CHANGELOG.md](CHANGELOG.md) for full release notes.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
